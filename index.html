<button type="submit" 
        id="submitBtn"
        class="forest-green-btn w-full text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition duration-300 tracking-widest text-lg">
    發送工單派遣申請
</button>

<div id="loadingNote" class="hidden mt-3 text-center">
    <p class="text-xs text-green-700 animate-pulse font-medium">
        ⏳ 正在進行安全驗證與資料連線，請稍候...
    </p>
    <p class="text-[10px] text-gray-400 mt-1">
        ( 伺服器回應約需 5-15 秒，請勿重新整理網頁 )
    </p>
</div>

<script>
    document.getElementById('repairForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const note = document.getElementById('loadingNote');
        
        // 1. 檢查機器人驗證
        const captchaResponse = grecaptcha.getResponse();
        if (!captchaResponse) {
            alert('請先勾選「我不是機器人」！');
            return;
        }

        // 啟動等待狀態
        btn.disabled = true;
        btn.innerText = '系統處理中...';
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        note.classList.remove('hidden'); // 顯示提示文字

        const formData = Object.fromEntries(new FormData(e.target));
        formData['captcha'] = captchaResponse;

        try {
            // 切換按鈕文字增加互動感
            setTimeout(() => { if(btn.disabled) btn.innerText = '正在同步資料庫...'; }, 3000);
            setTimeout(() => { if(btn.disabled) btn.innerText = '發送 LINE 通知中...'; }, 7000);

            const response = await fetch('https://my-line-bot-d0cc.onrender.com/submit_repair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok && result.status === "success") {
                alert('✅ 工單已成功派遣！我們會儘速聯繫您。');
                e.target.reset();
                grecaptcha.reset();
            } else {
                alert('❌ 送出失敗：' + (result.message || '請檢查網路後重試'));
            }
        } catch (error) {
            alert('❌ 無法連線至伺服器，可能因連線逾時，請檢查網路後再次試試。');
        } finally {
            // 恢復按鈕狀態
            btn.disabled = false;
            btn.innerText = '發送工單派遣申請';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            note.classList.add('hidden'); // 隱藏提示文字
        }
    };
</script>
