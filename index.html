<div class="space-y-3">
    <button type="submit" 
            id="submitBtn"
            class="forest-green-btn w-full text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition all duration-300 tracking-widest text-lg flex items-center justify-center">
        <span>發送工單派遣申請</span>
    </button>

    <div id="loadingNote" class="hidden">
        <div class="flex items-center justify-center space-x-2">
            <div class="w-2 h-2 bg-green-800 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-green-600 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
            <div class="w-2 h-2 bg-green-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
        </div>
        <p class="text-center text-[11px] text-gray-500 mt-2 leading-relaxed">
            系統正在與遠端伺服器連線中...<br>
            <span class="text-green-700 font-bold">資料傳輸約需 5-15 秒</span>，請耐心等候，請勿關閉視窗。
        </p>
    </div>
</div>

<script>
    document.getElementById('repairForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const note = document.getElementById('loadingNote');
        
        // 1. 檢查 reCAPTCHA
        const captchaResponse = grecaptcha.getResponse();
        if (!captchaResponse) {
            alert('請先勾選「我不是機器人」！');
            return;
        }

        // --- 進入「發送中」狀態 ---
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            資料封包傳送中...
        `;
        btn.classList.add('opacity-70', 'cursor-not-allowed');
        note.classList.remove('hidden'); // 秀出「請勿關閉視窗」的警告

        const formData = Object.fromEntries(new FormData(e.target));
        formData['captcha'] = captchaResponse;

        try {
            // 設定一個計時器，如果過 8 秒還沒跑完，按鈕文字再變一次，安撫人心
            const textTimer = setTimeout(() => {
                if(btn.disabled) btn.innerHTML = '正在同步 Google 雲端紀錄...';
            }, 7000);

            const response = await fetch('https://my-line-bot-d0cc.onrender.com/submit_repair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            clearTimeout(textTimer); // 跑完了就清除計時器
            const result = await response.json();

            if (response.ok && result.status === "success") {
                alert('✅ 報修單已成功送出！我們會儘速聯繫您。');
                e.target.reset();
                grecaptcha.reset();
            } else {
                alert('❌ 送出失敗：' + (result.message || '請檢查網路後重試'));
            }
        } catch (error) {
            alert('❌ 伺服器連線逾時，但資料可能已排隊處理中。請確認 LINE 是否有收到通知，若無請重試。');
        } finally {
            // 恢復原狀
            btn.disabled = false;
            btn.innerHTML = '<span>發送工單派遣申請</span>';
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
            note.classList.add('hidden');
        }
    };
</script>
